<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>Mugera ¬∑ join the circle</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:opsz@14..32&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', sans-serif;
            background: #0a0a0a;
            color: #e5e5e5;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        #app {
            display: flex;
            flex-direction: column;
            height: 100%;
            max-width: 600px;
            margin: 0 auto;
            width: 100%;
            background: #0f0f0f;
            border-left: 1px solid #222;
            border-right: 1px solid #222;
            position: relative;
        }
        /* JOIN MODAL */
        .join-overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.97);
            backdrop-filter: blur(6px);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1.2rem;
            overflow-y: auto;
        }
        .join-overlay.hidden { display: none; }
        .join-card {
            background: #151515;
            border-radius: 36px;
            padding: 2rem 1.5rem;
            width: 100%;
            max-width: 460px;
            border: 2px solid #ca8a04;
            box-shadow: 0 20px 40px rgba(202,138,4,0.25);
            max-height: 95vh;
            overflow-y: auto;
        }
        .join-card h2 {
            font-size: 2.2rem;
            font-weight: 700;
            color: #ca8a04;
            margin-bottom: 0.4rem;
        }
        .join-card p {
            color: #aaa;
            margin-bottom: 1.8rem;
            font-size: 0.95rem;
        }
        .form-field {
            margin-bottom: 1.4rem;
        }
        .form-label {
            display: block;
            color: #ccc;
            font-weight: 500;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }
        .join-input, .join-select {
            width: 100%;
            background: #1f1f1f;
            border: 2px solid #333;
            border-radius: 60px;
            padding: 0.9rem 1.2rem;
            font-size: 1rem;
            color: white;
        }
        .join-input:focus, .join-select:focus {
            outline: none;
            border-color: #ca8a04;
        }
        .interests-group {
            display: flex;
            flex-wrap: wrap;
            gap: 0.6rem 1rem;
            margin-top: 0.3rem;
        }
        .interest-option {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            color: #ddd;
            font-size: 0.9rem;
        }
        .interest-option input[type="checkbox"] {
            accent-color: #ca8a04;
            width: 18px; height: 18px;
        }
        .join-button {
            background: #ca8a04;
            color: black;
            border: none;
            border-radius: 60px;
            padding: 1rem;
            font-weight: 700;
            font-size: 1.1rem;
            width: 100%;
            cursor: pointer;
            transition: 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.6rem;
            margin-top: 1rem;
        }
        .join-button:hover { background: #b87c04; }
        .error-msg { color: #ff6b6b; font-size: 0.85rem; margin-top: 0.8rem; text-align: center; }

        /* header */
        .community-header {
            padding: 0.8rem 1rem;
            border-bottom: 1px solid #2a2a2a;
            background: #0f0f0f;
            display: flex;
            align-items: center;
            gap: 10px;
            flex-shrink: 0;
        }
        .community-header h2 {
            font-size: 1.3rem;
            font-weight: 600;
            color: #ca8a04;
            flex:1;
        }
        .avatar-small {
            width: 36px; height: 36px; border-radius: 50%;
            background: #ca8a04; color: black;
            display: flex; align-items: center; justify-content: center;
            font-weight: 700; border: 2px solid #ca8a04;
        }
        .online-badge {
            font-size: 0.7rem; color: #4caf50; margin-left: 0.3rem;
        }
        /* scrollable content area */
        .view-container {
            flex: 1;
            overflow-y: auto;
            padding: 0.8rem 0.8rem 0.2rem 0.8rem;
            -webkit-overflow-scrolling: touch;
            background: #0a0a0a;
        }
        /* post creator */
        .post-creator {
            background: #151515;
            border-radius: 24px;
            padding: 0.8rem;
            margin-bottom: 1.2rem;
            border: 1px solid #2a2a2a;
            display: flex;
            gap: 0.6rem;
        }
        .creator-avatar {
            width: 42px; height: 42px; border-radius: 50%;
            background: #ca8a04; color: black;
            display: flex; align-items: center; justify-content: center;
            font-weight: 700; flex-shrink:0;
        }
        .creator-input-area {
            flex:1;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .creator-input-area textarea {
            width:100%; background: #1f1f1f; border: 1px solid #333;
            border-radius: 20px; padding: 0.7rem; color: white;
            font-family: 'Inter', sans-serif; resize: none;
            font-size: 0.95rem;
        }
        .post-actions-bar {
            display: flex; justify-content: space-between; align-items: center;
        }
        .emoji-picker-btn {
            background: none; border: none; color: #ca8a04; font-size: 1.3rem;
            cursor: pointer; padding: 0 0.3rem;
        }
        .post-submit {
            background: #ca8a04; border: none; color: black; font-weight: 600;
            padding: 0.4rem 1.2rem; border-radius: 30px; cursor: pointer;
        }
        .post-submit:hover { background: #b87c04; }
        /* Post card */
        .post-card {
            background: #151515;
            border: 1px solid #2a2a2a;
            border-radius: 24px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        .post-header {
            display: flex; justify-content: space-between; align-items: flex-start;
        }
        .post-author {
            display: flex; gap: 0.7rem; align-items: center;
        }
        .post-avatar {
            width: 40px; height: 40px; border-radius: 50%;
            background: #ca8a04; color: black; display: flex;
            align-items: center; justify-content: center; font-weight: 700;
        }
        .post-time { font-size: 0.7rem; color: #888; }
        .post-menu { position: relative; }
        .menu-btn {
            background: none; border: none; color: #888; font-size: 1.2rem;
            cursor: pointer; padding: 0.3rem;
        }
        .menu-dropdown {
            position: absolute; right: 0; top: 25px; background: #252525;
            border: 1px solid #444; border-radius: 16px; padding: 0.4rem 0;
            display: none; flex-direction: column; min-width: 160px;
            z-index: 100;
        }
        .menu-dropdown.show { display: flex; }
        .menu-dropdown button {
            background: none; border: none; padding: 0.7rem 1rem;
            text-align: left; color: #ddd; font-size: 0.9rem;
            display: flex; align-items: center; gap: 0.6rem; cursor: pointer;
        }
        .menu-dropdown button:hover { background: #333; color: #ca8a04; }
        .post-content {
            font-size: 0.95rem; margin: 0.6rem 0 1rem 3rem;
            white-space: pre-wrap;
            word-break: break-word;
        }
        .post-stats {
            display: flex; gap: 1.2rem; margin-left: 3rem; margin-bottom: 0.5rem;
        }
        .stat-btn {
            background: none; border: none; color: #888;
            display: flex; align-items: center; gap: 0.4rem; font-size: 0.9rem;
            cursor: pointer;
        }
        .stat-btn.liked { color: #ca8a04; }
        .comment-section {
            margin-left: 3rem; margin-top: 0.8rem; border-top: 1px solid #2a2a2a;
            padding-top: 0.8rem;
        }
        .comment-input-area {
            display: flex; gap: 0.5rem; align-items: center;
            margin-bottom: 0.8rem;
        }
        .comment-input-area input {
            flex:1; background: #1f1f1f; border: 1px solid #333;
            border-radius: 40px; padding: 0.5rem 1rem; color: white;
        }
        .comment-input-area button {
            background: #ca8a04; border: none; color: black;
            border-radius: 40px; padding: 0.4rem 1rem; font-weight: 600;
            cursor: pointer;
        }
        .comment-item {
            display: flex; gap: 0.6rem; margin-top: 0.6rem;
        }
        .comment-avatar {
            width: 28px; height: 28px; border-radius: 50%;
            background: #ca8a04; color: black; display: flex;
            align-items: center; justify-content: center; font-size: 0.8rem;
        }
        .comment-body {
            background: #1f1f1f; padding: 0.4rem 1rem; border-radius: 18px;
        }
        .comment-name { font-weight: 600; font-size: 0.8rem; color: #ca8a04; }
        /* chats list */
        .chats-list {
            display: flex; flex-direction: column; gap: 0.5rem;
        }
        .chat-item {
            background: #151515; border-radius: 18px; padding: 1rem;
            border: 1px solid #2a2a2a; display: flex; gap: 1rem;
            align-items: center; cursor: pointer;
        }
        .chat-avatar {
            width: 48px; height: 48px; border-radius: 50%;
            background: #ca8a04; color: black; display: flex;
            align-items: center; justify-content: center; font-weight: 700;
        }
        /* chat detail */
        .chat-messages {
            flex:1; overflow-y: auto; padding: 0.5rem;
            display: flex; flex-direction: column; gap: 0.6rem;
        }
        .message {
            max-width: 75%; padding: 0.6rem 1rem; border-radius: 24px;
            background: #1f1f1f; align-self: flex-start;
        }
        .message.own { background: #2c2c2c; align-self: flex-end; }
        .chat-footer {
            display: flex; gap: 0.5rem; padding: 0.8rem; border-top: 1px solid #2a2a2a;
            background: #0f0f0f;
        }
        .chat-footer input {
            flex:1; background: #1f1f1f; border: 1px solid #333;
            border-radius: 40px; padding: 0.7rem 1rem; color: white;
        }
        .chat-footer button {
            background: #ca8a04; border: none; color: black;
            border-radius: 40px; padding: 0.7rem 1.2rem; font-weight: 600;
            cursor: pointer;
        }
        .back-btn {
            background: none; border: none; color: #ca8a04; font-size: 1.3rem;
            margin-right: 0.5rem; cursor: pointer;
        }
        /* bottom nav */
        .bottom-nav {
            display: flex;
            border-top: 1px solid #2a2a2a;
            background: #0f0f0f;
            padding: 0.2rem 0;
            justify-content: space-around;
            flex-shrink: 0;
            width: 100%;
        }
        .nav-btn {
            flex: 1 1 0;
            background: none; border: none; color: #888;
            font-size: 0.85rem; padding: 0.5rem 0.2rem;
            display: flex; flex-direction: column; align-items: center;
            gap: 0.1rem; cursor: pointer;
            min-width: 0;
        }
        .nav-btn i { font-size: 1.5rem; }
        .nav-btn span { font-size: 0.7rem; white-space: nowrap; }
        .nav-btn.active { color: #ca8a04; }
        .hidden { display: none !important; }
        .emoji-panel {
            display: flex; gap: 0.3rem; background: #252525; border-radius: 40px;
            padding: 0.3rem 0.6rem; border: 1px solid #444;
        }
        @media (max-width: 400px) {
            .nav-btn i { font-size: 1.3rem; }
            .nav-btn span { font-size: 0.6rem; }
        }
    </style>
</head>
<body>
<div id="app">
    <!-- JOIN OVERLAY -->
    <div class="join-overlay" id="joinOverlay">
        <div class="join-card">
            <h2>Join the circle</h2>
            <p>Become part of the Afrika Milele community.</p>
            <div class="form-field">
                <label class="form-label">Your name</label>
                <input type="text" class="join-input" id="userNameInput" placeholder="e.g., Wanjiku" maxlength="30">
            </div>
            <div class="form-field">
                <label class="form-label">How did you hear about us?</label>
                <select class="join-select" id="referrerSelect">
                    <option value="" disabled selected>Select one</option>
                    <option value="Facebook">Facebook</option>
                    <option value="TikTok">TikTok</option>
                    <option value="Instagram">Instagram</option>
                    <option value="Twitter">Twitter</option>
                    <option value="Friend">Friend</option>
                    <option value="Other">Other</option>
                </select>
            </div>
            <div class="form-field">
                <label class="form-label">Interests (select all that apply)</label>
                <div class="interests-group" id="interestsGroup">
                    <label class="interest-option"><input type="checkbox" value="Personal growth"> Personal growth</label>
                    <label class="interest-option"><input type="checkbox" value="African heritage"> African heritage</label>
                    <label class="interest-option"><input type="checkbox" value="Networking"> Networking</label>
                    <label class="interest-option"><input type="checkbox" value="Business"> Business</label>
                    <label class="interest-option"><input type="checkbox" value="Inspiration"> Inspiration</label>
                    <label class="interest-option"><input type="checkbox" value="Events"> Events</label>
                </div>
            </div>
            <button class="join-button" id="joinCommunityBtn"><i class="fas fa-hand-peace"></i> Join now</button>
            <div class="error-msg" id="joinError"></div>
        </div>
    </div>

    <!-- header -->
    <div class="community-header">
        <div class="avatar-small" id="headerAvatar">?</div>
        <h2>Community <span class="online-badge" id="onlineCountBadge">‚óè 0</span></h2>
        <i class="fas fa-ellipsis-h" style="color:#ca8a04;"></i>
    </div>

    <!-- feed view -->
    <div id="feedView" class="view-container">
        <div class="post-creator" id="postCreatorBox">
            <div class="creator-avatar" id="creatorAvatar">?</div>
            <div class="creator-input-area">
                <textarea id="postInput" placeholder="Share your thoughts..." rows="2"></textarea>
                <div class="post-actions-bar">
                    <div class="emoji-picker-btn" id="emojiToggle"><i class="far fa-smile"></i></div>
                    <div id="quickEmojiPanel" class="emoji-panel hidden">
                        <span>üòÄ</span><span>üòÇ</span><span>üòç</span><span>üî•</span><span>üëç</span><span>üíØ</span>
                    </div>
                    <button class="post-submit" id="submitPost">Post</button>
                </div>
            </div>
        </div>
        <div id="postsContainer"></div>
    </div>

    <!-- chats list view -->
    <div id="chatsView" class="view-container hidden">
        <div class="chats-list" id="chatsList"></div>
    </div>

    <!-- chat detail view -->
    <div id="chatDetailView" class="view-container hidden" style="padding:0; display: flex; flex-direction: column;">
        <div style="display: flex; align-items: center; padding: 0.6rem; border-bottom:1px solid #2a2a2a; background:#0f0f0f;">
            <button class="back-btn" id="backFromChat"><i class="fas fa-arrow-left"></i></button>
            <div id="chatPartnerName" style="font-weight:600; flex:1;">Loading...</div>
        </div>
        <div id="chatMessagesContainer" class="chat-messages"></div>
        <div class="chat-footer">
            <input type="text" id="chatMessageInput" placeholder="Message...">
            <button id="sendChatBtn"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>

    <!-- bottom navigation -->
    <div class="bottom-nav">
        <button class="nav-btn active" id="navFeed"><i class="fas fa-home"></i><span>Feed</span></button>
        <button class="nav-btn" id="navChats"><i class="fas fa-comment-dots"></i><span>Chats</span></button>
    </div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
<script>
    // firebase config
    const firebaseConfig = {
        apiKey: "AIzaSyC7kppUyHUaPzeLBV62NEZWuHiuz1Kz0mA",
        authDomain: "mugera-e51cc.firebaseapp.com",
        databaseURL: "https://mugera-e51cc-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "mugera-e51cc",
        storageBucket: "mugera-e51cc.firebasestorage.app",
        messagingSenderId: "1024868637509",
        appId: "1:1024868637509:web:321faecddce8f11d9cfc2c"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // ---------- GLOBAL STATE ----------
    let currentUser = null;

    // DOM elements
    const joinOverlay = document.getElementById('joinOverlay');
    const joinBtn = document.getElementById('joinCommunityBtn');
    const userNameInput = document.getElementById('userNameInput');
    const referrerSelect = document.getElementById('referrerSelect');
    const interestsCheckboxes = document.querySelectorAll('#interestsGroup input[type=checkbox]');
    const joinError = document.getElementById('joinError');

    // Check localStorage
    const savedUser = localStorage.getItem('mugera_user_v2');
    if (savedUser) {
        try {
            currentUser = JSON.parse(savedUser);
            joinOverlay.classList.add('hidden');
            updateUIAfterJoin();
        } catch (e) { 
            localStorage.removeItem('mugera_user_v2');
        }
    }

    // JOIN ACTION
    joinBtn.addEventListener('click', () => {
        const name = userNameInput.value.trim();
        if (!name) { 
            joinError.innerText = 'Please enter your name.'; 
            return; 
        }
        if (name.length < 2) { 
            joinError.innerText = 'Name too short.'; 
            return; 
        }

        const referrer = referrerSelect.value;
        if (!referrer) { 
            joinError.innerText = 'Please select how you heard about us.'; 
            return; 
        }

        const selectedInterests = Array.from(interestsCheckboxes)
            .filter(cb => cb.checked)
            .map(cb => cb.value);
        if (selectedInterests.length === 0) { 
            joinError.innerText = 'Select at least one interest.'; 
            return; 
        }

        joinBtn.disabled = true;
        joinBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Joining...';

        const userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substring(2,6);
        const newUser = {
            id: userId,
            name: name,
            avatar: name.charAt(0).toUpperCase(),
            joinedAt: new Date().toISOString(),
            referrer: referrer,
            interests: selectedInterests
        };

        // Save to Firebase
        db.ref(`users/${userId}`).set({
            id: userId,
            name: newUser.name,
            joinedAt: newUser.joinedAt,
            referrer: newUser.referrer,
            interests: newUser.interests
        }).then(() => {
            db.ref(`status/${userId}`).set({
                state: 'online',
                name: newUser.name,
                lastChanged: firebase.database.ServerValue.TIMESTAMP
            });
            db.ref(`status/${userId}`).onDisconnect().set({
                state: 'offline',
                lastChanged: firebase.database.ServerValue.TIMESTAMP
            });
            localStorage.setItem('mugera_user_v2', JSON.stringify(newUser));
            currentUser = newUser;
            joinOverlay.classList.add('hidden');
            updateUIAfterJoin();
            joinBtn.disabled = false;
            joinBtn.innerHTML = '<i class="fas fa-hand-peace"></i> Join now';
        }).catch(err => {
            console.error('Join error:', err);
            joinError.innerText = 'Network error. Try again.';
            joinBtn.disabled = false;
            joinBtn.innerHTML = '<i class="fas fa-hand-peace"></i> Join now';
        });
    });

    function updateUIAfterJoin() {
        if (!currentUser) return;
        document.querySelectorAll('.creator-avatar, #headerAvatar, #creatorAvatar').forEach(el => {
            el.textContent = currentUser.avatar || currentUser.name.charAt(0).toUpperCase();
        });
        
        // Clear any existing listeners before setting new ones
        db.ref('posts').off();
        db.ref('status').off();
        
        // Start listeners
        loadPosts();
        loadChatsList();
        
        db.ref('status').on('value', (snap) => {
            let online = 0;
            snap.forEach(c => { if (c.val().state === 'online') online++; });
            document.getElementById('onlineCountBadge').innerHTML = `‚óè ${online}`;
        });
    }

    // ---------- BOTTOM NAV ----------
    const feedView = document.getElementById('feedView');
    const chatsView = document.getElementById('chatsView');
    const chatDetailView = document.getElementById('chatDetailView');
    const navFeed = document.getElementById('navFeed');
    const navChats = document.getElementById('navChats');

    navFeed.addEventListener('click', () => {
        navFeed.classList.add('active');
        navChats.classList.remove('active');
        feedView.classList.remove('hidden');
        chatsView.classList.add('hidden');
        chatDetailView.classList.add('hidden');
    });
    
    navChats.addEventListener('click', () => {
        navFeed.classList.remove('active');
        navChats.classList.add('active');
        feedView.classList.add('hidden');
        chatsView.classList.remove('hidden');
        chatDetailView.classList.add('hidden');
        loadChatsList(); 
    });

    // ---------- POSTS - FIXED POSTING FUNCTIONALITY ----------
    function loadPosts() {
        if (!currentUser) return;
        
        db.ref('posts').orderByChild('timestamp').limitToLast(50).on('value', (snap) => {
            const posts = [];
            snap.forEach(child => {
                const post = child.val();
                post.id = child.key;
                posts.push(post);
            });
            // Sort by timestamp descending (newest first)
            posts.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
            renderPosts(posts);
        }, (error) => {
            console.error('Error loading posts:', error);
        });
    }

    function renderPosts(posts) {
        const container = document.getElementById('postsContainer');
        if (!container) return;
        container.innerHTML = '';
        
        if (posts.length === 0) {
            container.innerHTML = '<div style="text-align: center; color: #666; padding: 2rem;">No posts yet. Be the first to post!</div>';
            return;
        }
        
        posts.forEach(post => renderPost(post));
    }

    function renderPost(post) {
        const postDiv = document.createElement('div');
        postDiv.className = 'post-card';
        postDiv.id = `post-${post.id}`;
        
        const time = post.timestamp ? new Date(post.timestamp).toLocaleString() : 'just now';
        const userLiked = post.likes && post.likes[currentUser?.id] ? true : false;
        const likesCount = post.likesCount || 0;
        const comments = post.comments ? Object.values(post.comments) : [];
        const commentsCount = comments.length;
        
        let commentsHtml = '';
        comments.forEach(c => {
            if (!c) return;
            commentsHtml += `<div class="comment-item">
                <div class="comment-avatar">${c.userAvatar || c.userName?.charAt(0) || '?'}</div>
                <div class="comment-body"><span class="comment-name">${c.userName || ''}</span> ${c.text}</div>
            </div>`;
        });

        postDiv.innerHTML = `
            <div class="post-header">
                <div class="post-author">
                    <div class="post-avatar">${post.userAvatar || post.userName?.charAt(0) || 'U'}</div>
                    <div>
                        <div class="author-name">${post.userName || 'Unknown'}</div>
                        <span class="post-time">${time}</span>
                    </div>
                </div>
                <div class="post-menu">
                    <button class="menu-btn" onclick="toggleMenu('${post.id}')"><i class="fas fa-ellipsis-h"></i></button>
                    <div class="menu-dropdown" id="menu-${post.id}">
                        <button onclick="chatWithUser('${post.userId}')"><i class="fas fa-comment"></i> Chat with member</button>
                    </div>
                </div>
            </div>
            <div class="post-content">${post.content}</div>
            <div class="post-stats">
                <button class="stat-btn ${userLiked ? 'liked' : ''}" onclick="toggleLike('${post.id}')"><i class="fas fa-heart"></i> <span id="likes-${post.id}">${likesCount}</span></button>
                <button class="stat-btn" onclick="toggleComments('${post.id}')"><i class="fas fa-comment"></i> <span>${commentsCount}</span></button>
            </div>
            <div class="comment-section" id="comments-${post.id}" style="display: none;">
                <div class="comment-input-area">
                    <input type="text" id="commentInput-${post.id}" placeholder="Write a comment...">
                    <button onclick="addComment('${post.id}')">Post</button>
                </div>
                <div id="commentsList-${post.id}">${commentsHtml}</div>
            </div>
        `;
        document.getElementById('postsContainer').appendChild(postDiv);
    }

    // Global functions
    window.toggleMenu = (postId) => {
        document.querySelectorAll('.menu-dropdown').forEach(m => m.classList.remove('show'));
        const menu = document.getElementById(`menu-${postId}`);
        if (menu) menu.classList.toggle('show');
    };
    
    window.chatWithUser = (otherUserId) => {
        if (!currentUser) return;
        if (otherUserId === currentUser.id) { 
            alert('That\'s you!'); 
            return; 
        }
        navChats.click();
        setTimeout(() => openChat(otherUserId), 150);
    };
    
    window.toggleLike = (postId) => {
        if (!currentUser) return;
        const likeRef = db.ref(`posts/${postId}/likes/${currentUser.id}`);
        likeRef.once('value').then(snap => {
            if (snap.exists()) {
                likeRef.remove();
                db.ref(`posts/${postId}/likesCount`).transaction(c => Math.max(0, (c || 1) - 1));
            } else {
                likeRef.set(true);
                db.ref(`posts/${postId}/likesCount`).transaction(c => (c || 0) + 1);
            }
        });
    };
    
    window.toggleComments = (postId) => {
        const el = document.getElementById(`comments-${postId}`);
        if (el) el.style.display = el.style.display === 'none' ? 'block' : 'none';
    };
    
    window.addComment = (postId) => {
        if (!currentUser) return;
        const input = document.getElementById(`commentInput-${postId}`);
        if (!input.value.trim()) return;
        
        const comment = {
            userId: currentUser.id,
            userName: currentUser.name,
            userAvatar: currentUser.avatar,
            text: input.value.trim(),
            timestamp: firebase.database.ServerValue.TIMESTAMP
        };
        
        db.ref(`posts/${postId}/comments`).push(comment).then(() => {
            db.ref(`posts/${postId}/commentsCount`).transaction(c => (c || 0) + 1);
            input.value = '';
        });
    };

    // FIXED: Post submission
    document.getElementById('submitPost').addEventListener('click', submitPost);
    document.getElementById('postInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            submitPost();
        }
    });

    function submitPost() {
        if (!currentUser) {
            alert('Please join the community first');
            return;
        }
        
        const content = document.getElementById('postInput').value.trim();
        if (!content) {
            alert('Please enter some content');
            return;
        }
        
        const postBtn = document.getElementById('submitPost');
        postBtn.disabled = true;
        postBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        
        const post = {
            userId: currentUser.id,
            userName: currentUser.name,
            userAvatar: currentUser.avatar,
            content: content,
            timestamp: firebase.database.ServerValue.TIMESTAMP,
            likesCount: 0,
            commentsCount: 0
        };
        
        db.ref('posts').push(post)
            .then(() => {
                document.getElementById('postInput').value = '';
                postBtn.disabled = false;
                postBtn.innerHTML = 'Post';
            })
            .catch((error) => {
                console.error('Error posting:', error);
                alert('Failed to post. Please try again.');
                postBtn.disabled = false;
                postBtn.innerHTML = 'Post';
            });
    }

    // Emoji picker
    document.getElementById('emojiToggle').addEventListener('click', () => {
        document.getElementById('quickEmojiPanel').classList.toggle('hidden');
    });
    
    document.querySelectorAll('#quickEmojiPanel span').forEach(span => {
        span.addEventListener('click', (e) => {
            const input = document.getElementById('postInput');
            input.value += e.target.textContent;
            input.focus();
            document.getElementById('quickEmojiPanel').classList.add('hidden');
        });
    });

    // ---------- CHATS ----------
    let activeChatUserId = null;
    
    function loadChatsList() {
        if (!currentUser) return;
        
        db.ref('messages').orderByChild('participants/' + currentUser.id).equalTo(true).on('value', (snap) => {
            const chatMap = new Map();
            snap.forEach(msgSnap => {
                const msg = msgSnap.val();
                const chatId = msg.chatId;
                if (!chatId) return;
                
                const existing = chatMap.get(chatId);
                if (!existing || (msg.timestamp > (existing.lastMessage?.timestamp || 0))) {
                    const otherId = msg.senderId === currentUser.id ? msg.receiverId : msg.senderId;
                    chatMap.set(chatId, { lastMessage: msg, otherId });
                }
            });
            renderChatsList(Array.from(chatMap.values()));
        });
    }

    function renderChatsList(chats) {
        const list = document.getElementById('chatsList');
        list.innerHTML = '';
        
        if (chats.length === 0) {
            list.innerHTML = '<div style="text-align: center; color: #666; padding: 2rem;">No chats yet. Start by messaging someone from the feed!</div>';
            return;
        }
        
        chats.forEach(chat => {
            const otherId = chat.otherId;
            db.ref(`users/${otherId}/name`).once('value').then(snap => {
                const name = snap.val() || 'Unknown';
                const last = chat.lastMessage?.text || '...';
                const time = chat.lastMessage?.timestamp ? new Date(chat.lastMessage.timestamp).toLocaleTimeString() : '';
                
                const item = document.createElement('div');
                item.className = 'chat-item';
                item.setAttribute('data-other', otherId);
                item.innerHTML = `
                    <div class="chat-avatar">${name.charAt(0)}</div>
                    <div class="chat-preview">
                        <div class="chat-name">${name}</div>
                        <div class="chat-last">${last.substring(0, 30)}${last.length > 30 ? '...' : ''}</div>
                    </div>
                    <div class="chat-time">${time}</div>
                `;
                item.addEventListener('click', () => openChat(otherId));
                list.appendChild(item);
            });
        });
    }

    function openChat(otherUserId) {
        if (!currentUser) return;
        
        activeChatUserId = otherUserId;
        feedView.classList.add('hidden');
        chatsView.classList.add('hidden');
        chatDetailView.classList.remove('hidden');
        navFeed.classList.remove('active');
        navChats.classList.add('active');

        const chatId = [currentUser.id, otherUserId].sort().join('_');
        
        db.ref(`users/${otherUserId}/name`).once('value').then(snap => {
            document.getElementById('chatPartnerName').textContent = snap.val() || 'User';
        });
        
        const msgsRef = db.ref('messages').orderByChild('chatId').equalTo(chatId);
        msgsRef.off('value');
        msgsRef.on('value', (snap) => {
            const msgs = [];
            snap.forEach(m => msgs.push({ id: m.key, ...m.val() }));
            msgs.sort((a, b) => (a.timestamp || 0) - (b.timestamp || 0));
            
            const container = document.getElementById('chatMessagesContainer');
            container.innerHTML = '';
            
            msgs.forEach(m => {
                const div = document.createElement('div');
                div.className = `message ${m.senderId === currentUser.id ? 'own' : ''}`;
                div.textContent = m.text;
                container.appendChild(div);
            });
            container.scrollTop = container.scrollHeight;
        });
    }

    function sendMessage() {
        if (!currentUser || !activeChatUserId) return;
        
        const input = document.getElementById('chatMessageInput');
        const text = input.value.trim();
        if (!text) return;
        
        const chatId = [currentUser.id, activeChatUserId].sort().join('_');
        const message = {
            chatId: chatId,
            senderId: currentUser.id,
            receiverId: activeChatUserId,
            text: text,
            timestamp: firebase.database.ServerValue.TIMESTAMP,
            participants: { [currentUser.id]: true, [activeChatUserId]: true }
        };
        
        db.ref('messages').push(message).then(() => {
            input.value = '';
        });
    }

    document.getElementById('sendChatBtn').addEventListener('click', sendMessage);
    document.getElementById('chatMessageInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            sendMessage();
        }
    });

    document.getElementById('backFromChat').addEventListener('click', () => {
        chatDetailView.classList.add('hidden');
        chatsView.classList.remove('hidden');
        feedView.classList.add('hidden');
        navFeed.classList.remove('active');
        navChats.classList.add('active');
        activeChatUserId = null;
    });

    // Close menus when clicking outside
    document.addEventListener('click', (e) => {
        if (!e.target.closest('.menu-btn')) {
            document.querySelectorAll('.menu-dropdown').forEach(m => m.classList.remove('show'));
        }
    });

    // Initialize if user already logged in
    if (currentUser) {
        updateUIAfterJoin();
    }
</script>
</body>
</html>
